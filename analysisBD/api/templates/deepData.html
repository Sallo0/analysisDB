<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>Поиск через колено</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
</head>
<body>
 <header>
     <h1 class="title">Поиск через колено</h1>
     <img class="img-urfu" src="{% static 'css/urfu.png'%}" alt="лого УрФУ">
     <img class="img-sbis" src="{% static 'css/sbis.png'%}" alt="лого СБИС">
  </header>


  <form class="requestForm">
           <div>
               <div class="db-type input-container">
                   <label class="label db-type-label" for="db-type">База данных</label>
                   <select class="select-db select" id="db-type" required>
                       <option selected value="PostgreSQL">PostgreSQL</option>
                       <option value="OrientDB">OrientDB</option>
                       <option value="Neo4j">Neo4j</option>
                   </select>
                </div>
               <div>
                   <div class="input-container child-container">
                       <label for="child" class="label child-label">ID дочернего объекта</label>
                       <input class="select" id="child" type="text" placeholder="child...">
                   </div>
               </div>
           </div>

           <div>
               <button type="button" value="Отправить" onclick="sendRequest(1)">Отправить</button>
           </div>

  </form>
 <div class="data"></div>
 <div class="pages">
     <button type="button" value="Отправить" class="btn-preview" onclick="getPage(false)">Предыдущая</button>
     <button type="button" value="Отправить" class="btn-next" onclick="getPage(true)">Следующая</button>
 </div>
 <script>
     window.localStorage['page'] = 1;
     document.querySelector(".btn-preview").style.display = "none";
     document.querySelector(".btn-next").style.display = "none";
 </script>
 <script>
     function getPage(flag){
         if (flag){
             window.localStorage['page'] += 1;
             console.log(window.localStorage['page']);
             document.querySelector(".btn-preview").style.display = "inline-block";
         }
         else {
             window.localStorage['page'] -= 1;
             console.log(window.localStorage['page']);
             if (window.localStorage['page'] === 1){
                document.querySelector(".btn-preview").style.display = "none";
             }
         }
         sendRequest(window.localStorage['page'])
     }

     function sendRequest(page) {
         let spinner = document.createElement("div");
         spinner.classList.add("spinner");
         spinner.setAttribute("id", "spinner")
         document.querySelector(".requestForm").append(spinner);

         let data = {
             'dbtype': '',
             'mainfilter': {
                 'Child': 0,
             },
             'page': page,
         }

         let result = getInputValue(data)

         fetch(`http://46.48.3.74:8000/` + "getdeepdata", {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json;charset=utf-8'
             },
             body: JSON.stringify(result)
         })
             .then(response => {
                 if (response.ok) {
                     return response.json()
                 }
             })
             .then(data => {
                 let selectDB = document.querySelector(".select-db");

                 if (selectDB.options[selectDB.selectedIndex].value === "PostgreSQL"){
                    parserDataPostgres(data)
                }
                else if (selectDB.options[selectDB.selectedIndex].value === "Neo4j"){
                    parserDataNeo4j(data)
                }
                else if (selectDB.options[selectDB.selectedIndex].value === "OrientDB"){
                    parserDataOrientDB(data)
                }

                document.querySelector(".btn-next").style.display = "inline-block";
             });
     }

     function parserDataNeo4j(data) {
         document.querySelector('.data').innerHTML = "";
         let pages = document.querySelector('.pages');
         //pages.innerHTML = "";

         console.log(data)

         let result = data['result']
         let time_block = document.createElement("div");
         time_block.classList.add("time");
         time_block.innerHTML = `Найдено за ${data['time']} сек`;
         document.querySelector('.data').append(time_block);

         let records_container = document.createElement("div");
         records_container.classList.add("deep-records-container");

         for (let record in result){
             let record_container = document.createElement("div")
             record_container.classList.add("deep-record-container");

             for (let i = 0; i < result[record].length; i++){
                 if (i === 0){
                     let child = document.createElement("div")
                     child.classList.add("deep-child-container")
                     child.innerHTML = `
                        <div class="deep-child-item">Face_id: ${result[record][i]['pk']}</div>
                        <div class="deep-child-item">Face_name: ${result[record][i]['face_name']}</div>
                        <div class="deep-child-item">Face_type: ${result[record][i]['face_type']}</div>
                     `
                     record_container.append(child)
                 }
                 else {
                     let parent = document.createElement("div")
                     parent.classList.add("deep-parent-container")
                     parent.innerHTML = `
                        <div class="deep-parent-item">Face_id: ${result[record][i]['pk']}</div>
                        <div class="deep-parent-item">Face_name: ${result[record][i]['face_name']}</div>
                        <div class="deep-parent-item">Face_type: ${result[record][i]['face_type']}</div>
                     `
                     record_container.append(parent);
                 }
             }
             records_container.append(record_container);
         }
         document.querySelector('.data').append(records_container)


         document.getElementById("spinner").remove();
     }

     function getInputValue(data){
            let result = data;
            let selectDB = document.querySelector(".select-db");

            result['dbtype'] = selectDB.options[selectDB.selectedIndex].value;
            result['mainfilter']['Child'] = document.querySelector("#child").value;

            return result
        }
 </script>

</body>
</html>