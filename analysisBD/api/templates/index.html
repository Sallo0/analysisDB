<!DOCTYPE html>
<html lang="ru">
<head>
    {% load static %}
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Пример веб-страницы</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
 </head>
 <body>
  <h1>Анализ баз данных</h1>
  <!-- Комментарий -->
  <div>
      <!-- Пока отказались от этой реализации
      <a href="postgresql"><button type="button">PostgreSQL</button></a>
      <a href="orientdb"><button type="button">OrientDB</button></a>
      <a href="neo4j"><button type="button">Neo4j</button></a>
      -->
       <form class="requestForm">
           <select class="select-db" required>
               <option selected value="PostgreSQL">PostgreSQL</option>
               <option value="OrientDB">OrientDB</option>
               <option value="Neo4j">Neo4j</option>
           </select>

           <select class="select-mainFilter" onchange="displayInput()" required>
               <option class="option-none" value="-">-</option>
               <option value="Child">Child</option>
               <option value="Parent">Parent</option>
               <option value="All">All</option>
           </select>

           <div class="filter-input">
               <input class="child" type="text" placeholder="child...">
               <input class="parent" type="text" placeholder="parent...">
           </div>

           <select class="select-kind">
               <option value="-">-</option>
               <option value="1">1</option>
               <option value="2">2</option>
               <option value="3">3</option>
               <option value="4">4</option>
               <option value="5">5</option>
               <option value="6">6</option>
           </select>

           <input type="date" class="date-begin">
           <input type="date" class="date-end">
           <input type="text" class="cost" placeholder="cost">
           <input type="text" class="share" placeholder="share">

           <select class="select-childLiquidated">
               <option selected value="-">-</option>
               <option value="false">Нет</option>
               <option value="true">Да</option>
           </select>

           <button type="button" value="Отправить" onclick="sendRequest()">Отправить</button>

       </form>
  </div>
  <div class="data"></div>
    <script>
        function displayInput(){
            let selectBox = document.querySelector(".select-mainFilter");
            let selectedValue = selectBox.options[selectBox.selectedIndex].value;
            document.querySelector(".filter-input").style.display = "inline-block";

            let option = document.querySelector(".option-none");
            if (option != null) document.querySelector(".option-none").remove();

            if (selectedValue === "Child") {
                document.querySelector(".parent").style.display = "none";
                document.querySelector(".child").style.display = "block";
            }else if (selectedValue === "Parent"){
                document.querySelector(".parent").style.display = "block";
                document.querySelector(".child").style.display = "none";
            }else if (selectedValue === "All"){
                document.querySelector(".child").style.display = "block";
                document.querySelector(".parent").style.display = "block";
            }
        }

        function getInputValue(data){
            let result = data;
            let selectDB = document.querySelector(".select-db");
            let selectKind = document.querySelector(".select-kind");
            let selectChildLiq = document.querySelector(".select-childLiquidated");

            result['dbtype'] = selectDB.options[selectDB.selectedIndex].value;
            result['mainfilter']['Child'] = document.querySelector(".child").value;
            result['mainfilter']['Parent'] = document.querySelector(".parent").value;
            result['kind'] = selectKind.options[selectKind.selectedIndex].value;
            result['date_begin'] = document.querySelector(".date-begin").value;
            result['date_end'] = document.querySelector(".date-end").value;
            result['cost'] = document.querySelector(".cost").value;
            result['share'] = document.querySelector(".share").value;
            result['child_liquidated'] = selectChildLiq.options[selectChildLiq.selectedIndex].value;

            return result
        }

        function sendRequest(){
            let spinner = document.createElement("div")
            spinner.classList.add("spinner");
            spinner.setAttribute("id", "spinner")
            document.querySelector(".requestForm").append(spinner)

            let data = {
                'dbtype': '',
                'mainfilter': {
                    'Child': 0,
                    'Parent': 0
                },
                'kind': '',
                'date_begin': '',
                'date_end': '',
                'cost': '',
                'share': '',
                'child_liquidated': ''
            }

            let result = getInputValue(data)

            fetch(`http://46.48.3.74:8000/` + "getdata", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(result)
            })
            .then(response => {
                if (response.ok) {
                        return response.json()
                    }
            })
            .then(data => {

                let selectDB = document.querySelector(".select-db");

                if (selectDB.options[selectDB.selectedIndex].value === "PostgreSQL"){
                    parserDataPostgres(data)
                }
                else if (selectDB.options[selectDB.selectedIndex].value === "Neo4j"){
                    parserDataNeo4j(data)
                }


            });

            function parserDataNeo4j(data){
                console.log(data)
                document.querySelector('.data').innerHTML = ""

                let records = document.createElement("div");

                data['result'].forEach(record => {
                    let node_type = ''

                    let record_container = document.createElement("div");

                    if (Object.keys(record).length !== 1) {
                        node_type = Object.keys(record)[1]
                        let parent_container = document.createElement("div");
                        parent_container.classList.add("parentContainer")
                        parent_container.innerHTML = `
                            <div class="parentItem pk">pk: ${record[node_type]['pk']}</div>
                            <div class="parentItem face-name">name: ${record[node_type]['face_name']}</div>
                            <div class="parentItem face-type">type: ${record[node_type]['face_type']}</div>
                        `
                        record_container.append(parent_container)
                    }

                    let properties = document.createElement("div");
                    properties.classList.add("propertiesContainer")
                    properties.innerHTML = `
                        <div class="propertiesItem kind">тип связи: ${record['PROPERTIES(r)']['kind']}</div>
                        <div class="propertiesItem date-begin">начало: ${record['PROPERTIES(r)']['date_begin']}</div>
                        <div class="propertiesItem date-end">конец: ${record['PROPERTIES(r)']['date_end']}</div>
                        <div class="propertiesItem share">доля: ${record['PROPERTIES(r)']['share']}</div>
                        <div class="propertiesItem cost">стоимость: ${record['PROPERTIES(r)']['cost']}</div>
                        <div class="propertiesItem child-liquidated">child-liquidated: ${record['PROPERTIES(r)']['child_liquidated']}</div>

                    `
                    record_container.append(properties)

                    records.append(record_container)
                })

                let time_block = document.createElement("div");
                time_block.classList.add("time");
                time_block.innerHTML =`Найдено за ${data['time']} сек`

                document.querySelector('.data').append(time_block)
                document.querySelector('.data').append(records)
            }

            function parserDataPostgres(data){
                let records = document.createElement("div");
                let temp = data.split(']')
                let timer = temp[1]

                records = temp[0].split("{")
                records.splice(0,1);

                document.querySelector('.data').innerHTML = ""

                records.forEach(record => {
                    let record_container = document.createElement("div");
                    record_container.classList.add("recordContainer");
                    let record_arr = record.split(",");
                    record_arr.forEach(e =>{
                        if (e != " "){
                            let block = document.createElement("div");
                            block.classList.add("recordItem");
                            block.innerHTML = e;
                            record_container.append(block);
                        }
                    })

                    document.querySelector('.data').append(record_container)
                })
                let form = document.querySelector(".requestForm")
                console.log(form)
                form.removeChild(form.lastChild)
                console.log(form.lastChild)

                document.querySelector('.data').append(timer);
            }


        }
    </script>
 </body>
</html>